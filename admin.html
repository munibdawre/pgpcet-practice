<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - PGP-CET</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    select, input, button { border-radius: 0.5rem !important; }
    .modal-content { background-color: #1c1c1c; color: #fff; border: 1px solid #444; }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg mb-4">
    <div class="container-fluid">
      <a class="navbar-brand fw-bold" href="#">PGP-CET Admin</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a href="index.html" class="nav-link">Home</a></li>
          <li class="nav-item"><a href="upload.html" class="nav-link">Upload</a></li>
          <li class="nav-item"><a href="attempt.html" class="nav-link">Attempt Test</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container">
    <!-- USER MANAGEMENT -->
    <div class="card mb-4 p-3">
      <h4 class="mb-3">Live Logged-in Users</h4>
      <table class="table table-hover align-middle" id="userTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Last Login</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- QUESTION BANK -->
    <div class="card p-3">
      <h4 class="mb-3">Question Bank</h4>
      <div class="d-flex flex-wrap gap-2 align-items-center mb-3">
        <label for="subjectSelect" class="form-label mb-0">Filter by Subject:</label>
        <select id="subjectSelect" class="form-select w-auto">
          <option value="">All Subjects</option>
          <option>Anatomy</option>
          <option>Physiology</option>
          <option>Biochemistry</option>
          <option>Fundamentals of Exercise Therapy</option>
          <option>Fundamentals of Electro Therapy</option>
          <option>Pharmacology</option>
          <option>Pathology & Microbiology</option>
          <option>Psychology</option>
          <option>Psychiatry</option>
          <option>Electrical Agents</option>
          <option>Kinesio Therapeutics</option>
          <option>General Surgery & Orthopedics</option>
          <option>Medicine</option>
          <option>OBGY</option>
          <option>Physical Diagnosis & Manipulative Skills</option>
          <option>Physiotherapy in Musculoskeletal Condition</option>
          <option>Physiotherapy in Neurosciences</option>
          <option>Physiotherapy in General Medical & Gen. surgical condition</option>
          <option>Physiotherapy in Community Health</option>
        </select>
      </div>

      <table class="table table-striped align-middle" id="questionTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Subject</th>
            <th>Question</th>
            <th>Answer</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- USER SCORE MODAL -->
  <div class="modal fade" id="scoreModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">User Scores</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <table class="table table-bordered" id="scoreTable">
            <thead>
              <tr><th>#</th><th>Subject</th><th>Score</th><th>Date</th><th>Actions</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- CHANGE PASSWORD MODAL -->
  <div class="modal fade" id="passwordModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Change Password</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="password" id="newPass" class="form-control mb-2" placeholder="Enter new password"/>
          <button class="btn btn-success w-100" id="btnSavePass">Save Password</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUserIndex = null;

    // Load Live Users
    function loadUsers() {
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      const loggedIn = JSON.parse(localStorage.getItem("loggedInUsers") || "[]");
      const userTable = document.querySelector("#userTable tbody");
      userTable.innerHTML = "";

      loggedIn.forEach((email, i) => {
        const u = users.find(x => x.email === email);
        if (u) {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${i + 1}</td>
            <td>${u.username}</td>
            <td>${u.email}</td>
            <td>${u.lastLogin || "Now"}</td>
            <td>
              <button class="btn btn-info btn-sm me-1" onclick="viewScores('${u.email}')">Scores</button>
              <button class="btn btn-warning btn-sm me-1" onclick="openPasswordModal(${users.indexOf(u)})">Change Password</button>
              <button class="btn btn-danger btn-sm" onclick="deleteUser(${users.indexOf(u)})">Delete</button>
            </td>`;
          userTable.appendChild(row);
        }
      });
    }

    // Delete User
    function deleteUser(index) {
      if (confirm("Delete this user?")) {
        const users = JSON.parse(localStorage.getItem("users") || "[]");
        users.splice(index, 1);
        localStorage.setItem("users", JSON.stringify(users));
        loadUsers();
      }
    }

    // View Scores
    function viewScores(email) {
      const scores = JSON.parse(localStorage.getItem("scores_" + email) || "[]");
      const table = document.querySelector("#scoreTable tbody");
      table.innerHTML = "";
      scores.forEach((s, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${s.subject}</td>
          <td>${s.score}</td>
          <td>${s.date}</td>
          <td><button class="btn btn-danger btn-sm" onclick="deleteScore('${email}', ${i})">Delete</button></td>`;
        table.appendChild(row);
      });
      new bootstrap.Modal(document.getElementById("scoreModal")).show();
    }

    function deleteScore(email, i) {
      if (confirm("Delete this score?")) {
        const key = "scores_" + email;
        const scores = JSON.parse(localStorage.getItem(key) || "[]");
        scores.splice(i, 1);
        localStorage.setItem(key, JSON.stringify(scores));
        viewScores(email);
      }
    }

    // Password Modal
    function openPasswordModal(index) {
      currentUserIndex = index;
      new bootstrap.Modal(document.getElementById("passwordModal")).show();
    }

    document.getElementById("btnSavePass").addEventListener("click", () => {
      const newPass = document.getElementById("newPass").value.trim();
      if (!newPass) return alert("Enter a new password");
      const users = JSON.parse(localStorage.getItem("users") || "[]");
      if (currentUserIndex !== null && users[currentUserIndex]) {
        users[currentUserIndex].password = newPass;
        localStorage.setItem("users", JSON.stringify(users));
        alert("Password updated successfully");
        bootstrap.Modal.getInstance(document.getElementById("passwordModal")).hide();
      }
    });

    // Load Questions
    function loadQuestions(subject = "") {
      const tbody = document.querySelector("#questionTable tbody");
      tbody.innerHTML = "";
      const subjects = [
        "Anatomy","Physiology","Biochemistry","Fundamentals of Exercise Therapy",
        "Fundamentals of Electro Therapy","Pharmacology","Pathology & Microbiology",
        "Psychology","Psychiatry","Electrical Agents","Kinesio Therapeutics",
        "General Surgery & Orthopedics","Medicine","OBGY",
        "Physical Diagnosis & Manipulative Skills","Physiotherapy in Musculoskeletal Condition",
        "Physiotherapy in Neurosciences","Physiotherapy in General Medical & Gen. surgical condition",
        "Physiotherapy in Community Health"
      ];
      let allQuestions = [];
      subjects.forEach(sub => {
        const qList = JSON.parse(localStorage.getItem("questions_" + sub) || "[]");
        qList.forEach(q => allQuestions.push({ ...q, subject: sub }));
      });
      if (subject) allQuestions = allQuestions.filter(q => q.subject === subject);
      allQuestions.forEach((q, i) => {
        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${q.subject}</td>
          <td>${q.question}</td>
          <td>${q.answer}</td>
          <td><button class="btn btn-danger btn-sm" onclick="deleteQuestion('${q.subject}', ${i})">Delete</button></td>`;
        tbody.appendChild(row);
      });
    }

    function deleteQuestion(subject, i) {
      if (confirm("Delete this question?")) {
        const key = "questions_" + subject;
        const questions = JSON.parse(localStorage.getItem(key) || "[]");
        questions.splice(i, 1);
        localStorage.setItem(key, JSON.stringify(questions));
        loadQuestions(subject);
      }
    }

    document.getElementById("subjectSelect").addEventListener("change", e => loadQuestions(e.target.value));

    // INIT
    loadUsers();
    loadQuestions();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
