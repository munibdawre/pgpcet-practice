<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PGPCET Practice — Attempt Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script type="module">
    // ✅ Firebase Configuration
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyB6RuIeIbu34cIHqoScC3NYfpZHqXy2SME",
      authDomain: "pgpcet-practice.firebaseapp.com",
      projectId: "pgpcet-practice",
      storageBucket: "pgpcet-practice.firebasestorage.app",
      messagingSenderId: "332921568405",
      appId: "1:332921568405:web:475087028328263a982f9c",
      measurementId: "G-H67DHPRCMR"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // ✅ Subject distribution (PGPCET official)
    const subjects = {
      "Anatomy": 4, "Physiology": 4, "Biochemistry": 2,
      "Fundamentals of Exercise Therapy": 5, "Fundamentals of Electro Therapy": 5,
      "Pharmacology": 2, "Pathology & Microbiology": 4,
      "Psychology": 1, "Psychiatry": 1, "Electrical Agents": 7,
      "Kinesio Therapeutics": 7, "General Surgery & Orthopedics": 6,
      "Medicine": 6, "OBGY": 3, "Physical Diagnosis & Manipulative Skills": 8,
      "Physiotherapy in Musculoskeletal Condition": 10,
      "Physiotherapy in Neurosciences": 10,
      "Physiotherapy in General Medical & General Surgical Condition": 10,
      "Physiotherapy in Community Health": 5
    };

    let allQuestions = [];
    let currentQ = 0;
    let userAnswers = {};

    // Load all subject questions from Firestore
    async function loadQuestions() {
      allQuestions = [];
      for (const subj in subjects) {
        const qRef = collection(db, "questions", subj, "items");
        const qs = await getDocs(qRef);
        const qArr = qs.docs.map(d => d.data());
        qArr.sort(() => 0.5 - Math.random());
        allQuestions.push(...qArr.slice(0, subjects[subj]));
      }
      renderQuestion();
      startTimer(90 * 60);
    }

    // Timer setup
    function startTimer(seconds) {
      const timerDisplay = document.getElementById("timeLeft");
      const timer = setInterval(() => {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        timerDisplay.textContent = `Time left: ${m}:${s.toString().padStart(2, '0')}`;
        if (seconds <= 0) {
          clearInterval(timer);
          submitTest();
        }
        seconds--;
      }, 1000);
    }

    function renderQuestion() {
      const q = allQuestions[currentQ];
      if (!q) return;
      document.getElementById("qCount").textContent = `Q ${currentQ + 1} / ${allQuestions.length}`;
      const qArea = document.getElementById("questionArea");
      qArea.innerHTML = `
        <div class="card p-3 shadow-sm">
          <h5>${q.question}</h5>
          <div class="mt-3">
            ${['A','B','C','D'].map(opt => `
              <div class="form-check">
                <input class="form-check-input" type="radio" name="option" value="${opt}" 
                  ${userAnswers[currentQ] === opt ? 'checked' : ''}>
                <label class="form-check-label">${q[`option${opt}`]}</label>
              </div>`).join('')}
          </div>
        </div>`;
    }

    // Navigation functions
    window.prevQ = function() {
      if (currentQ > 0) {
        saveAnswer();
        currentQ--;
        renderQuestion();
      }
    };
    window.saveNext = function() {
      saveAnswer();
      if (currentQ < allQuestions.length - 1) {
        currentQ++;
        renderQuestion();
      } else {
        submitTest();
      }
    };

    function saveAnswer() {
      const opt = document.querySelector('input[name="option"]:checked');
      if (opt) userAnswers[currentQ] = opt.value;
    }

    // Submit test
    window.submitTest = async function() {
      saveAnswer();
      let score = 0;
      let resultsHTML = "";
      allQuestions.forEach((q, i) => {
        const userAns = userAnswers[i] || "-";
        const correct = q.answer === userAns;
        if (correct) score++;
        resultsHTML += `
          <div class="card p-2 mt-2 ${correct ? 'border-success' : 'border-danger'}">
            <b>Q${i + 1}.</b> ${q.question}<br>
            <small>Your Answer: ${userAns} | Correct: ${q.answer}</small><br>
            <small class="text-muted">Explanation: ${q.explanation || 'Not available'}</small>
          </div>`;
      });

      document.getElementById("questionArea").innerHTML = `
        <h4 class="text-center mt-4">Test Completed</h4>
        <p class="text-center">Score: ${score} / ${allQuestions.length}</p>
        <div>${resultsHTML}</div>`;
      document.getElementById("controls").style.display = "none";

      const user = auth.currentUser;
      if (user) {
        const attemptRef = doc(db, "users", user.uid, "attempts", new Date().toISOString());
        await setDoc(attemptRef, {
          score, total: allQuestions.length, date: new Date().toLocaleString()
        });
      }
    };

    // Authentication check
    onAuthStateChanged(auth, user => {
      if (!user) location.href = "index.html";
      else loadQuestions();
    });
  </script>
</head>

<body class="bg-light">
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
      <a class="navbar-brand" href="home.html">PGP-CET Practice</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="home.html">Home</a></li>
          <li class="nav-item"><a class="nav-link" href="upload.html">Upload</a></li>
          <li class="nav-item"><a class="nav-link" href="#" onclick="signOut()">Logout</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Test area -->
  <main class="container my-4">
    <div class="d-flex justify-content-between mb-3">
      <div id="timeLeft" class="fw-semibold text-danger">Time left: 90:00</div>
      <div id="qCount" class="fw-semibold">Q 1 / 100</div>
    </div>

    <div id="questionArea"></div>

    <div id="controls" class="mt-3 d-flex gap-2">
      <button class="btn btn-outline-secondary" onclick="prevQ()">Previous</button>
      <button class="btn btn-primary" onclick="saveNext()">Save & Next</button>
      <button class="btn btn-success" onclick="submitTest()">Submit Test</button>
    </div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
<!-- attempt.html placeholder -->
